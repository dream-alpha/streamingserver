#!/bin/sh
set -e

CHROOT_DIR=/data/ubuntu
ENIGMA2_DIR=/usr/lib/enigma2/python/Plugins/SystemPlugins/streamingserver
UBUNTU_DIR=$CHROOT_DIR/root/plugins/streamingserver
mkdir -p $UBUNTU_DIR

cp $ENIGMA2_DIR/Version.py $ENIGMA2_DIR/src/version.py
cp -avr $ENIGMA2_DIR/src/* $UBUNTU_DIR/

$CHROOT_DIR/root/mount_chroot

# Set environment variables to prevent systemd issues in chroot
export DEBIAN_FRONTEND=noninteractive
export DEBCONF_NONINTERACTIVE_SEEN=true

chroot "$CHROOT_DIR" /bin/bash -c "
    export DEBIAN_FRONTEND=noninteractive
    export DEBCONF_NONINTERACTIVE_SEEN=true
    
    # Fix any broken packages first
    echo '[*] Fixing broken packages...'
    dpkg --configure -a --force-depends || true
    
    echo '[*] Updating plugin packages...'
    /root/venv/bin/pip install -r /root/plugins/streamingserver/requirements.txt
    
    echo '[*] Cleaning up package configuration...'
    apt-get autoremove -y || true
    apt-get clean || true
"

dpkg-trigger --no-await streamingserver-update-trigger

$CHROOT_DIR/root/umount_chroot
echo "***********************************"
echo "*         streamingserver         *"
echo "*               by                *"
echo "*          dream-alpha            *"
echo "***********************************"
echo ""
echo "Plugin successfully installed."
exit 0
